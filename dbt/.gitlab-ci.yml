image: datacoves/dbt-coves

stages:
  - prep
  - test
  - docs
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DBT_PROFILES_DIR: .config

cache:
  paths:
    - dbt_modules/

before_script:
  - dbt deps

setup:
  stage: prep
  script:
  - echo Starting Run
  - echo $DBT_PROFILES_DIR
  - pwd
  - DBT_DATABASE=$TEST_DATABASE dbt seed --full-refresh

lint:
  stage: test
  needs: ["setup"]
  script:
  - sqlfluff lint models

test:
  stage: test
  needs: ["setup"]
  script:
  - DBT_DATABASE=$TEST_DATABASE dbt test
# - DBT_DATABASE=$TEST_DATABASE dbt-coves check

dbt_docs:
  stage: docs
  needs: ["lint","test"]
  script:
  - DBT_DATABASE=$TEST_DATABASE dbt docs generate
  - mv target public
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - public
    expire_in: 4 weeks
  except:
  - master

pages:
  stage: deploy
  script:
  - DBT_DATABASE=$PROD_DATABASE dbt docs generate
  - mv target public
  artifacts:
    paths:
    - public
  only:
  - master